<!doctype html>
<html><head><title>实验二——中国区EKS权限管理</title><meta charset="UTF-8"><link href="http://fonts.googleapis.com/css?family=Crimson+Text:400,400italic,700,700italic|Roboto:400,700,700italic,400italic" rel="stylesheet" type="text/css"><style>/*
 * Copyright 2014 Quip
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */

body {
    font-size: 15px;
    color: #333;
    background: white;
    padding: 60px 95px;
    max-width: 900px;
    margin: 0 auto;
    text-rendering: optimizeLegibility;
    font-feature-settings: "kern";
    font-kerning: normal;
    -moz-font-feature-settings: "kern";
    -webkit-font-feature-settings: "kern";
}

/* Headings */
h1,
h2,
h3,
th {
    font-family: Roboto, sans-serif;
    font-weight: 700;
    margin: 0;
    margin-top: 1.25em;
    margin-bottom: 0.75em;
}

h1 {
    font-size: 35px;
    line-height: 42px;
}

h1:first-child {
    margin-top: 0;
}

h2 {
    font-size: 18px;
    line-height: 22px;
}

h3 {
    font-size: 13px;
    line-height: 16px;
}

.capitalize-h3 h3 {
    text-transform: uppercase;
}

/* Body text */
body,
p,
ul,
ol,
td {
    font-family: "Crimson Text", serif;
    font-size: 16px;
    line-height: 20px;
}

blockquote,
q {
    display: block;
    margin: 1em 0;
    font-style: italic;
}

blockquote a,
q a {
    text-decoration: underline;
}

blockquote {
    padding-left: 10px;
    border-left: 4px solid #a6a6a6;
}

q {
    color: #a6a6a6;
    line-height: 40px;
    font-size: 24px;
    text-align: center;
    quotes: none;
}

q a {
    color: #a6a6a6;
}

code,
pre {
    font-family: Consolas, "Liberation Mono", Menlo, "Courier Prime Web",
        Courier, monospace;
    background: #f2f2f2;
}

code {
    padding: 1px;
    margin: 0 -1px;
    border-radius: 3px;
}

pre {
    display: block;
    line-height: 20px;
    text-shadow: 0 1px white;
    padding: 5px 5px 5px 30px;
    white-space: nowrap;
    position: relative;
    margin: 1em 0;
}

pre:before {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    left: 15px;
    border-left: solid 1px #dadada;
}

/* Lists */
div[data-section-style="5"],
div[data-section-style="6"],
div[data-section-style="7"] {
    margin: 12px 0;
}

ul {
    padding: 0 0 0 40px;
}

ul li {
    margin-bottom: 0.4em;
}

/* Bulleted list */
div[data-section-style="5"] ul {
    list-style-type: disc;
}
div[data-section-style="5"] ul ul {
    list-style-type: circle;
}
div[data-section-style="5"] ul ul ul {
    list-style-type: square;
}
div[data-section-style="5"] ul ul ul ul {
    list-style-type: disc;
}
div[data-section-style="5"] ul ul ul ul ul {
    list-style-type: circle;
}
div[data-section-style="5"] ul ul ul ul ul ul {
    list-style-type: square;
}

/* Numbered list */
div[data-section-style="6"] ul {
    list-style-type: decimal;
}
div[data-section-style="6"] ul ul {
    list-style-type: lower-alpha;
}
div[data-section-style="6"] ul ul ul {
    list-style-type: lower-roman;
}
div[data-section-style="6"] ul ul ul ul {
    list-style-type: decimal;
}
div[data-section-style="6"] ul ul ul ul ul {
    list-style-type: lower-alpha;
}
div[data-section-style="6"] ul ul ul ul ul ul {
    list-style-type: lower-roman;
}

/* Checklist */
div[data-section-style="7"] ul {
    list-style-type: none;
}

div[data-section-style="7"] ul li:before {
    content: "\2610";
    position: absolute;
    display: inline;
    margin-right: 1.2em;
    margin-left: -1.2em;
}

div[data-section-style="7"] ul li.parent:before {
    content: "";
}

div[data-section-style="7"] ul li.checked {
    text-decoration: line-through;
}

div[data-section-style="7"] ul li.checked:before {
    content: "\2611";
    text-decoration: none;
}

/* Tables */
div[data-section-style="8"] {
    margin: 12px 0;
}

table {
    border-spacing: 0;
    border-collapse: separate;
    border: solid 1px #bbb;
    table-layout: fixed;
    position: relative;
}

table th,
table td {
    padding: 2px 2px 0;
    min-width: 1.5em;
    word-wrap: break-word;
}

table th {
    border-bottom: 1px solid #c7cbd1;
    background: #f2f2f2;
    font-weight: bold;
    vertical-align: bottom;
    color: #3a4449;
    text-align: center;
}

table td {
    padding-top: 0;
    border-left: 1px solid #c7cbd1;
    border-top: 1px solid #c7cbd1;
    vertical-align: top;
}

table td.bold {
    font-weight: bold;
}

table td.italic {
    font-style: italic;
}

table td.underline {
    text-decoration: underline;
}

table td.strikethrough {
    text-decoration: line-through;
}

table td.underline.strikethrough {
    text-decoration: underline line-through;
}

table td:first-child {
    border-left: hidden;
}

table tr:first-child td {
    border-top: hidden;
}

/* Images */
div[data-section-style="11"] {
    margin-top: 20px;
    margin-bottom: 20px;
    margin-left: auto;
    margin-right: auto;
}

div[data-section-style="11"][data-section-float="0"] {
    clear: both;
    text-align: center;
}

div[data-section-style="11"][data-section-float="1"] {
    float: left;
    clear: left;
    margin-right: 20px;
}

div[data-section-style="11"][data-section-float="2"] {
    float: right;
    clear: right;
    margin-left: 20px;
}

div[data-section-style="11"] img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: auto;
}

hr {
    width: 70px;
    margin: 20px auto;
}

/* Apps */
div[data-section-style="19"].placeholder {
    margin: 0.8em auto;
    padding: 4px 0;
    display: block;
    color: #3d87f5;
    text-align: center;
    border: 1px solid rgba(41, 182, 242, 0.2);
    border-radius: 3px;
    background: #e9f8fe;
    font-family: Roboto, sans-serif;
}

div[data-section-style="19"].first-party-element {
    margin-bottom: 10px;
    background-repeat: no-repeat;
    background-size: contain;
}

div[data-section-style="19"].first-party-element.kanban {
    background-image: url("https://quip-cdn.com/nK0hSyhsb4jrLIL2s5Ma-g");
    height: 166px;
}

div[data-section-style="19"].first-party-element.calendar {
    background-image: url("https://quip-cdn.com/OYujqLny03RILxcLIiyERg");
    height: 244px;
}

div[data-section-style="19"].first-party-element.poll {
    background-image: url("https://quip-cdn.com/fbIiFrcKGv__4NB7CBfxoA");
    height: 116px;
}

div[data-section-style="19"].first-party-element.countdown {
    background-image: url("https://quip-cdn.com/3bPhykD2dBei9sSjCWteTQ");
    height: 96px;
}

div[data-section-style="19"].first-party-element.process_bar {
    background-image: url("https://quip-cdn.com/ybQlHnHEIIBLog5rZmYs_w");
    height: 36px;
}

div[data-section-style="19"].first-party-element.project_tracker {
    background-image: url("https://quip-cdn.com/OFQU087b4Mxzz1ZaHwtjXA");
    height: 164px;
}

div[data-section-style="19"] img {
    margin: 0.5em;
}

div[data-section-style="19"] img.masked-image {
    margin: 0;
    transform-origin: top left;
}

div[data-section-style="19"] .image-mask {
    position: relative;
    overflow: hidden;
}
/*
 * Copyright 2019 Quip
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */

body {
    counter-reset: indent0 indent1 indent2 indent3 indent4 indent5 indent6
        indent7 indent8;
}

/* Numbered list */
div[data-section-style="6"] {
    counter-reset: indent0 indent1 indent2 indent3 indent4 indent5 indent6
        indent7 indent8;
}
div[data-section-style="6"].list-numbering-continue {
    counter-reset: none;
}
div[data-section-style="6"].list-numbering-restart-at {
    counter-reset: indent0 var(--indent0) indent1 indent2 indent3 indent4
        indent5 indent6 indent7 indent8;
}
div[data-section-style="6"] ul {
    /* indent0 is not reset since it is shared across the div elements */
    list-style-type: none !important;
}
div[data-section-style="6"] ul ul {
    counter-reset: indent1;
}
div[data-section-style="6"] ul ul ul {
    counter-reset: indent2;
}
div[data-section-style="6"] ul ul ul ul {
    counter-reset: indent3;
}
div[data-section-style="6"] ul ul ul ul ul {
    counter-reset: indent4;
}
div[data-section-style="6"] ul ul ul ul ul ul {
    counter-reset: indent5;
}
div[data-section-style="6"] ul li {
    counter-increment: indent0;
}
div[data-section-style="6"] ul ul li {
    counter-increment: indent1;
}
div[data-section-style="6"] ul ul ul li {
    counter-increment: indent2;
}
div[data-section-style="6"] ul ul ul ul li {
    counter-increment: indent3;
}
div[data-section-style="6"] ul ul ul ul ul li {
    counter-increment: indent4;
}
div[data-section-style="6"] ul ul ul ul ul ul li {
    counter-increment: indent5;
}
div[data-section-style="6"] ul li:before {
    content: counter(indent0, decimal) ". ";
}
div[data-section-style="6"] ul ul li:before {
    content: counter(indent1, lower-alpha) ". ";
}
div[data-section-style="6"] ul ul ul li:before {
    content: counter(indent2, lower-roman) ". ";
}
div[data-section-style="6"] ul ul ul ul li:before {
    content: counter(indent3, decimal) ". ";
}
div[data-section-style="6"] ul ul ul ul ul li:before {
    content: counter(indent4, lower-alpha) ". ";
}
div[data-section-style="6"] ul ul ul ul ul ul li:before {
    content: counter(indent5, lower-roman) ". ";
}
</style></head><body><h1 id='EQU9CAj17Xc'>实验二——中国区EKS权限管理</h1>

<h2 id='EQU9CAy6z35'>前提准备</h2>

<div data-section-style='5' class="" style=""><ul id='EQU9CA1KOBE'><li id='EQU9CANUaZu' class='' value='1'>已部署好的EKS集群

<br/></li><li id='EQU9CAKC0J2' class=''>创建一个S3桶

<br/></li><li id='EQU9CAjnj1e' class=''>IAM <span style="color:#333333" textcolor="#333333">AdministratorAccess</span>

<br/></li><li id='EQU9CAkmh7j' class='parent'>确定awscli版本（至少为1.18.15）

<br/></li><ul><li id='EQU9CAELAWQ' class=''>执行<code>aws --version</code>可以看到如下所示：

<br/></li></ul></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/7CFS4f9uS948xdo6onOhuw?a=yXVzZXajx5gzaYcfNCRhiGLa48cM9kixkMHUJtALZjsa' id='EQU9CAUTWgX' alt=''></img></div><br/>

<br/>

<br/>

<h2 id='EQU9CAhRdCQ'>Lab 1——通过RBAC实现集群访问控制</h2>

<h3 id='EQU9CA2vxhH'>实验步骤</h3>

<br/>

<b>1. 将iam user map到k8s并进行测试</b><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAsGZjd'><li id='EQU9CAL3YZU' class='' value='1'>创建新的namespace与nginx pod

<br/></li></ul></div><pre id='EQU9CArbOFX'><code>kubectl create </code><code>namespace</code><code> rbac</code><code>-</code><code>test<br>kubectl create deploy nginx --image=nginx -n rbac-test<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAJ2koM'><li id='EQU9CAGgVmL' class='' value='1'>执行<code>kubectl get all -n rbac-test</code>查看pod状态，等待pod创建完成

<br/></li></ul></div><div data-section-style='11' style='max-width:78%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/WjGTjHpMv1MCk7GwFUg7rw?a=sBTQdWeGeoygx7sWQddrqVZm5awmlryepHsb9oHKnowa' id='EQU9CAC4Brx' alt=''></img></div><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAMMCaP'><li id='EQU9CAl3gLE' class='' value='1'>创建一个iam用户

<br/></li></ul></div><pre id='EQU9CAB8REk'><code>aws iam create</code><code>-</code><code>user </code><code>--</code><code>user</code><code>-</code><code>name rbac</code><code>-</code><code>user<br>aws iam create-access-key --user-name rbac-user | tee /tmp/create_output.json<br></code></pre>

<div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/T7h8GNBcnImr2pX6ySxfoQ?a=ho8mnjfhaoYiHYsMWA0cTgnIhg8mkoaa8aVzeNRbm8ca' id='EQU9CAZKtn6' alt=''></img></div><br/>

<div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/0IQ2XNnilSRWzK_P9Ka84w?a=igQasJoCgaagdigLSK7UWVIpxkpWlooYFV96HJQdlQQa' id='EQU9CAypoes' alt='' width='800' height='174'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAfyMY3'><li id='EQU9CAv9myN' class='' value='1'>记录aksk，放入<code>rbacuser_creds.sh</code>脚本当中，方便执行

<br/></li></ul></div><pre id='EQU9CAzrb4O'>vim rbacuser_creds.sh<br><br><code>export</code><code> AWS_SECRET_ACCESS_KEY</code><code>=</code><code>$</code><code>(</code><code>jq </code><code>-</code><code>r </code><code>.</code><code>AccessKey</code><code>.</code><code>SecretAccessKey</code><code> </code><code>/</code><code>tmp</code><code>/</code><code>create_output</code><code>.</code><code>json</code><code>)<br>export AWS_ACCESS_KEY_ID=$(jq -r .AccessKey.AccessKeyId /tmp/create_output.json)<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAPd69E'><li id='EQU9CA1aJJT' class='' value='1'>创建k8s用户rbac-user，并将它map到之前创建的iam用户

<br/></li></ul></div><pre id='EQU9CALRwfH'>vim <code>aws-auth.yaml</code><br><br>apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: aws-auth<br>  namespace: kube-system<br>data:<br>  mapUsers: |<br>    - userarn: arn:aws-cn:iam::${ACCOUNT_ID}:user/rbac-user<br>      username: rbac-user</pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAwN0SO'><li id='EQU9CAyyWt7' class='' value='1'>执行<code>kubectl apply -f aws-auth.yaml</code>

<br/></li><li id='EQU9CAMEjd7' class=''>执行<code>kubectl edit -n kube-system configmap/aws-auth</code>可以看到

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/KizjNkIZoU4hjz-enBvKjw?a=mg4NALdVvKDG0vucIg8tNdJRaaHDCCvxNFSt7pB0NQIa' id='EQU9CAlQlLe' alt='' width='800' height='355'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAvVSIJ'><li id='EQU9CAK27p5' class='' value='1'>执行<code>. rbacuser_creds.sh</code>（即切换aksk为iam用户rbac-user），再执行<code>kubectl get pods -n rbac-test</code>发现报错没有权限

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/EXwuXoLqEqLF0CzYMGGLmw?a=Z5ltDrRvarH4sTL83jW3IjeXqqV1YkchAGwpfjTw2AYa' id='EQU9CA3nzao' alt='' width='800' height='30'></img></div><b>2. 创建role binding</b><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAHr15r'><li id='EQU9CAFqKxO' class='' value='1'>切换回Admin用户

<br/></li></ul></div><pre id='EQU9CAQVzuK'><code>unset AWS_SECRET_ACCESS_KEY<br>unset AWS_ACCESS_KEY_ID<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAK1FBS'><li id='EQU9CAOraVA' class='' value='1'>创建rbac role

<br/></li></ul></div><pre id='EQU9CA0pIus'>vim <code>rbacuser</code><code>-</code><code>role</code><code>.</code><code>yaml<br><br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  namespace: rbac-test<br>  name: pod-reader<br>rules:<br>- apiGroups: [""] # "" indicates the core API group<br>  resources: ["pods"]<br>  verbs: ["list","get","watch"]<br>- apiGroups: ["extensions","apps"]<br>  resources: ["deployments"]<br>  verbs: ["get", "list", "watch"]<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CA8pZiH'><li id='EQU9CA1m7ts' class='' value='1'>创建role binding

<br/></li></ul></div><pre id='EQU9CA4V4PZ'>vim <code>rbacuser</code><code>-</code><code>role</code><code>-</code><code>binding</code><code>.</code><code>yaml<br><br>kind: RoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: read-pods<br>  namespace: rbac-test<br>subjects:<br>- kind: User<br>  name: rbac-user<br>  apiGroup: rbac.authorization.k8s.io<br>roleRef:<br>  kind: Role<br>  name: pod-reader<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAICgXU'><li id='EQU9CAr91tx' class='' value='1'>执行kubectl apply

<br/></li></ul></div><pre id='EQU9CAUkHAp'><code>kubectl apply </code><code>-</code><code>f rbacuser</code><code>-</code><code>role</code><code>.</code><code>yaml</code><code><br>kubectl apply -f rbacuser-role-binding.yaml<br></code></pre>

<b>3. 重新切换回rbac-user，进行测试</b><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAcJFAR'><li id='EQU9CA3Q9Kt' class='' value='1'>执行<code>. rbacuser_creds.sh</code>

<br/></li><li id='EQU9CAu3Yb8' class=''>执行<code>kubectl get pods -n rbac-test</code>，发现拥有了可以看到名为rbac-test的namespace下的pod

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/283-bTbN7x9-oN95sIuaJA?a=MOAITJaH5ZVmH98AZO0CmPRELNclZTaoaxewVAQp7jca' id='EQU9CAzAgNu' alt=''></img></div><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAbXhJS'><li id='EQU9CA5SZ4E' class='' value='1'>执行<code>kubectl get pods -n kube-system</code>但由于没有看kube-system的权限，所以无权查看该namespace（kube-system）下的pod

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/CN5ib-Vrz4i1UvUWAbgOKA?a=P7sUs97lzhL59hHZEkYEN1Ma5m4qd4kCwkle1WGgvYga' id='EQU9CADfCim' alt='' width='800' height='27'></img></div><b>4. 清理资源</b><br/>

<pre id='EQU9CAjGOtq'><code>unset AWS_SECRET_ACCESS_KEY</code><br><code>unset AWS_ACCESS_KEY_ID</code><br><code>kubectl </code><code>delete</code><code> </code><code>namespace</code><code> rbac</code><code>-</code><code>test</code><br><code>rm rbacuser_creds</code><code>.</code><code>sh</code><br><code>rm rbacuser</code><code>-</code><code>role</code><code>.</code><code>yaml</code><br><code>rm rbacuser</code><code>-</code><code>role</code><code>-</code><code>binding</code><code>.</code><code>yaml</code><br><code>aws iam </code><code>delete</code><code>-</code><code>access</code><code>-</code><code>key </code><code>--</code><code>user</code><code>-</code><code>name</code><code>=</code><code>rbac</code><code>-</code><code>user </code><code>--</code><code>access</code><code>-</code><code>key</code><code>-</code><code>id</code><code>=</code><code>$</code><code>(</code><code>jq </code><code>-</code><code>r </code><code>.</code><code>AccessKey</code><code>.</code><code>AccessKeyId</code><code> </code><code>/</code><code>tmp</code><code>/</code><code>create_output</code><code>.</code><code>json</code><code>)</code><br><code>aws iam </code><code>delete</code><code>-</code><code>user </code><code>--</code><code>user</code><code>-</code><code>name rbac</code><code>-</code><code>user<br>rm /tmp/create_output.json</code></pre>

<br/>

<h2 id='EQU9CAJ9kFr'>Lab 2——通过IRSA实现pod对AWS服务的调用</h2>

<h3 id='EQU9CAQvrfJ'>实验步骤</h3>

<b>1. 为集群创建OIDC身份验证提供商与IRSA</b><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAGGY0I'><li id='EQU9CAzot57' class='' value='1'>执行<code>eksctl utils associate-iam-oidc-provider --cluster YOUR_CLUSTER_NAME --approve</code>

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/MAoL0WIb6wWrV7u1vkouvQ?a=EKpGAlHxmG8xE9AI52FoJeTT3dMjmdBFQ3aammuyuqYa' id='EQU9CAdQByw' alt='' width='800' height='91'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAdEe97'><li id='EQU9CA3obN4' class='' value='1'>查看iam console，发现身份验证提供商已创建完成

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/u7vtJj8GeJc7wEqNBO4ZOg?a=82U5VH6KlikbeCyv7XKOanOSX69LQiKKz4wIdvcCHxsa' id='EQU9CAQ8Yo0' alt='' width='800' height='204'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAoXWay'><li id='EQU9CAN84dU' class='' value='1'>执行<code>eksctl create iamserviceaccount --name iam-test --namespace default --cluster YOUR_CLUSTER_NAME --attach-policy-arn arn:aws-cn:iam::aws:policy/AmazonS3ReadOnlyAccess --approve --override-existing-serviceaccounts</code>创建IRSA，在这里赋予其s3fullaccess权限

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/GVmvStrBiP_4NUUxVnV36g?a=qpQSR4A5zeVa5pjabzJE4nJWQV3UZKEO2xcODxoSU9Ia' id='EQU9CA4Hihx' alt='' width='800' height='132'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAJ18uk'><li id='EQU9CADNKgk' class='' value='1'>执行<code>kubectl get sa</code>可以找到刚刚新创建的service account

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/UAQPAIf_QlU6ATHRFh6R-w?a=K37tEOD0R7IZ89kcma2YAadajopKuzFvW0JTHVOU7bca' id='EQU9CAKoTCX' alt=''></img></div><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAcuTzH'><li id='EQU9CA7giR5' class='' value='1'>执行<code>kubectl describe sa iam-test</code>，可以发现其中的annotations对应iam console上的role

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/k3gWVYE8D6KoCpAE13F4UQ?a=pX8XKnbllFTCnsQaqoXEv6LqYWo5VTcxa4AxiG1bhOoa' id='EQU9CArP1cC' alt='' width='800' height='129'></img></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/FtajX-3Cy_XRZaM5Jh2v-w?a=Whvq9s9CWmkGLirHJ12YXnaO7FpNis2k6DT4OaHiwcsa' id='EQU9CAlzvyB' alt='' width='800' height='358'></img></div><b>2. 创建用来测试的pod，并赋予其service accout</b><br/>

<div data-section-style='5' class="" style=""><ul id='EQU9CAvZfVb'><li id='EQU9CAMFclU' class='' value='1'>创建部署pod的yaml文件，可以看到其中的serviceAccountName指向之前创建好的iam-test

<br/></li></ul></div><pre id='EQU9CAf5dgb'>vim <code>iam</code><code>-</code><code>pod</code><code>.</code><code>yaml<br><br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>    name: eks-iam-test<br>spec:<br>    replicas: 1<br>    selector:<br>        matchLabels:<br>            app: eks-iam-test<br>    template:<br>        metadata:<br>            labels:<br>                app: eks-iam-test<br>        spec:<br>            serviceAccountName: iam-test<br>            containers:<br>            - name: eks-iam-test<br>              image: sdscello/awscli:latest<br>              ports:<br>              - containerPort: 80<br></code></pre>

<div data-section-style='5' class="" style=""><ul id='EQU9CAlPEYz'><li id='EQU9CACqtr2' class='' value='1'>执行<code>kubectl apply -f iam-pod.yaml</code>，通过<code>kubectl get pods</code>查看pod状态，直至ready

<br/></li><li id='EQU9CAkA2SN' class=''>执行<code>kubectl exec -it &lt;Pod Name&gt; /bin/bash</code>进入pod（如果报No OpenIDConnect provider的错可能需要重新登录几次，等待几分钟）

<br/></li><li id='EQU9CAvZaIG' class=''>执行<code>aws s3 ls --region cn-northwest-1</code>可以看到s3桶被列出来

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/OEPNLXwMuAJWMdZzSWZVsQ?a=hvVx458UgzSCVgFx1FX5xN2Qf3co9HeD4t2ivZqwEwIa' id='EQU9CAvhgVY' alt='' width='645' height='148'></img></div><div data-section-style='5' class="" style=""><ul id='EQU9CAzMhOW'><li id='EQU9CABmbp4' class='' value='1'>执行<code>aws ec2 describe-instances --region cn-northwest-1</code>发现没有权限

<br/></li></ul></div><div data-section-style='11' style='max-width:100%'><img src='https://quip-amazon.com/blob/EQU9AAITNsd/f_WghgIqWDufjtAOlcKGoQ?a=sNDsGPr0LA6zMkPrSvdymKwmARruMz8qRErWb5UcFfMa' id='EQU9CARR6k6' alt='' width='800' height='56'></img></div><b>3. 清理资源</b><br/>

<pre id='EQU9CA1VHUm'><code>kubectl </code><code>delete</code><code> </code><code>-</code><code>f iam</code><code>-</code><code>pod</code><code>.</code><code>yaml</code><br><code>eksctl </code><code>delete</code><code> iamserviceaccount </code><code>--</code><code>name iam</code><code>-</code><code>test </code><code>--</code><code>namespace</code><code> </code><code>default</code><code> </code><code>--</code><code>cluster YOUR_CLUSTER_NAME</code></pre>

<br/>

<br/>

<br/>

<br/>

<br/>

<br/>

<br/>

<br/>

</body></html>